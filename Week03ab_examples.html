<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Data manipulation examples</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #0000ff; } /* Keyword */
code > span.ch { color: #008080; } /* Char */
code > span.st { color: #008080; } /* String */
code > span.co { color: #008000; } /* Comment */
code > span.ot { color: #ff4000; } /* Other */
code > span.al { color: #ff0000; } /* Alert */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #008000; font-weight: bold; } /* Warning */
code > span.cn { } /* Constant */
code > span.sc { color: #008080; } /* SpecialChar */
code > span.vs { color: #008080; } /* VerbatimString */
code > span.ss { color: #008080; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { } /* Variable */
code > span.cf { color: #0000ff; } /* ControlFlow */
code > span.op { } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #ff4000; } /* Preprocessor */
code > span.do { color: #008000; } /* Documentation */
code > span.an { color: #008000; } /* Annotation */
code > span.cv { color: #008000; } /* CommentVar */
code > span.at { } /* Attribute */
code > span.in { color: #008000; } /* Information */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="libs\style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->



<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Data Manipulation
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 02</li>
    <li>
      <a href="Week02a.html">Data types</a>
    </li>
    <li>
      <a href="Week02b.html">Reading and writing data files</a>
    </li>
    <li>
      <a href="Week02c.html">Working with date objects</a>
    </li>
    <li>
      <a href="Week02d.html">Exploring and cleaning dataframes using base functions</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 03</li>
    <li>
      <a href="Week03a.html">Manipulating dataframes with dplyr</a>
    </li>
    <li>
      <a href="Week03d.html">Working with string objects</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 04</li>
    <li>
      <a href="Week03ab_groupby.html">Grouping and summarizing tables</a>
    </li>
    <li>
      <a href="Week03b.html">Tidying/reshaping tables using tidyr</a>
    </li>
    <li>
      <a href="Week03c.html">Joining data tables</a>
    </li>
    <li>
      <a href="Week03ab_examples.html">Example of data manipulation workflows</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Plots
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 05</li>
    <li>
      <a href="Week04a.html">The base plotting environment</a>
    </li>
    <li>
      <a href="Week04b.html">The lattice plotting environment</a>
    </li>
    <li>
      <a href="Week04c.html">The ggplot plotting environment</a>
    </li>
    <li>
      <a href="Week04d.html">Manipulating colors in R</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Univariate
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 06</li>
    <li>
      <a href="Week05a.html">Visualizing univariate data</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 07</li>
    <li>
      <a href="Week05b.html">Comparing univariate data distributions</a>
    </li>
    <li>
      <a href="Week06a.html">Theoretical Q-Q plot</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 08</li>
    <li>
      <a href="Week07a.html">Fits and residuals</a>
    </li>
    <li>
      <a href="Week07b.html">Spread-location plot</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 09</li>
    <li>
      <a href="Week08a.html">Re-expressing data</a>
    </li>
    <li>
      <a href="Week08b.html">Letter value summaries</a>
    </li>
    <li>
      <a href="Week08c.html">The Two R’s of EDA</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Bivariate
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 10</li>
    <li>
      <a href="Week09a.html">Bivariate analysis</a>
    </li>
    <li>
      <a href="Week09b.html">Resistant lines</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 11</li>
    <li>
      <a href="Week10a.html">The third R of EDA: Residuals</a>
    </li>
    <li>
      <a href="Week10b.html">Detecting discontinuities in the data</a>
    </li>
    <li>
      <a href="http://mgimond.github.io/Stats-in-R/regression.html">Details of the OLS regression method (optional reading)</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Two-way tables
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 12</li>
    <li>
      <a href="Week11a.html">Median polish/Mean polish</a>
    </li>
    <li>
      <a href="http://mgimond.github.io/Stats-in-R/ANOVA.html">Details of an ANOVA (optional reading)</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Misc
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Misc01.html">R markdown documents</a>
    </li>
    <li class="dropdown-header">Week 13</li>
    <li>
      <a href="Week12a.html">Creating maps in R</a>
    </li>
    <li class="dropdown-header">Connecting to relational databases</li>
  </ul>
</li>
<li>
  <a href="Data.html">Datasets</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->
<link href="https://fonts.googleapis.com/css?family=Open+Sans%7CSource+Code+Pro" rel="stylesheet">

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Data manipulation examples</h1>

</div>


<div style="color:#ff7535; background-color:#fff0ee ;   border-left-style: solid">
<p>This tutorial makes use of the following R package(s): <strong><code>dplyr</code></strong>, <strong><code>tidyr</code></strong> and <strong><code>stringr</code></strong></p>
</div>
<p>The following data are used in some of the subsequent tutorials (including the one on <code>ggplot2</code>) and make use of some advanced data manipulation routines. The input data file formats are provided as is by their source and are modified to facilitate ingestion into some the plotting routines covered in later exercises. Data used in this tutorial include grain harvest for north america and income/education census data for the US.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat1 &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;http://mgimond.github.io/ES218/Data/FAO_grains_NA.csv&quot;</span>, <span class="dt">header=</span><span class="ot">TRUE</span>)
dat2 &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;http://mgimond.github.io/ES218/Data/Income_education.csv&quot;</span>, <span class="dt">header=</span><span class="ot">TRUE</span>)</code></pre></div>
<div id="dataset-dat1" class="section level2">
<h2>Dataset <code>dat1</code></h2>
<p><code>dat1</code> consists of grain yields by north american countries and by year. The dataset was downloaded from <a href="http://faostat3.fao.org/" class="uri">http://faostat3.fao.org/</a> in June of 2014.</p>
<p>A subset of <code>dat1</code> will be used in later tutorials in both a <em>wide</em> form and a <em>long</em> form. The wide form will be called <code>dat1w</code> and will be a table of year vs. crop yields.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">library</span>(tidyr)

dat1w &lt;-<span class="st"> </span>dat1 <span class="op">%&gt;%</span>
<span class="st">         </span><span class="kw">filter</span>(Information <span class="op">==</span><span class="st"> &quot;Yield (Hg/Ha)&quot;</span>, 
                Country     <span class="op">==</span><span class="st">&quot;United States of America&quot;</span>, 
                Crop       <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Oats&quot;</span>, <span class="st">&quot;Maize&quot;</span>, <span class="st">&quot;Barley&quot;</span>, <span class="st">&quot;Buckwheat&quot;</span>,<span class="st">&quot;Rye&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">         </span><span class="kw">select</span>(Year, Crop, Value)                                          <span class="op">%&gt;%</span>
<span class="st">         </span><span class="kw">spread</span>(<span class="dt">key =</span> Crop, <span class="dt">value=</span><span class="st">&quot;Value&quot;</span>)
<span class="kw">head</span>(dat1w)</code></pre></div>
<pre><code>  Year   Barley Buckwheat    Maize     Oats      Rye
1 1961 16488.52  10886.67 39183.63 15171.26 11121.79
2 1962 18839.00  11737.50 40620.80 16224.60 12892.77
3 1963 18808.27  11995.00 42595.55 16253.04 11524.11
4 1964 20208.88  11566.50 39498.36 15471.55 12026.24
5 1965 23070.58  11875.00 46492.14 18001.04 14192.91
6 1966 20581.66  11956.52 45891.88 16117.92 13670.75</code></pre>
<p>The <em>long</em> form version of the subset will be called <code>dat1l</code> and will be a <em>long</em> form representation of <code>dat1w</code> (yield by crop and year).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat1l &lt;-<span class="st"> </span><span class="kw">gather</span>(dat1w, <span class="dt">key =</span> <span class="st">&quot;Crop&quot;</span>, <span class="dt">value =</span> <span class="st">&quot;Yield&quot;</span>, <span class="dv">2</span><span class="op">:</span><span class="dv">6</span>)
<span class="kw">head</span>(dat1l,<span class="dv">10</span>)</code></pre></div>
<pre><code>   Year   Crop    Yield
1  1961 Barley 16488.52
2  1962 Barley 18839.00
3  1963 Barley 18808.27
4  1964 Barley 20208.88
5  1965 Barley 23070.58
6  1966 Barley 20581.66
7  1967 Barley 21785.30
8  1968 Barley 23557.07
9  1969 Barley 24039.46
10 1970 Barley 23048.77</code></pre>
<p>Another subset will be used in subsequent exercises and will consist of total yields for each year by crop and country.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat1l2 &lt;-<span class="st"> </span>dat1 <span class="op">%&gt;%</span>
<span class="st">          </span><span class="kw">filter</span>(Information <span class="op">==</span><span class="st"> &quot;Yield (Hg/Ha)&quot;</span>, 
                 Crop       <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Oats&quot;</span>, <span class="st">&quot;Maize&quot;</span>, <span class="st">&quot;Barley&quot;</span>, <span class="st">&quot;Buckwheat&quot;</span>,<span class="st">&quot;Rye&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">          </span><span class="kw">select</span>( Year, Crop, Country,  <span class="dt">Yield =</span> Value)  <span class="co"># Note that we are renaming the Value field</span>

<span class="kw">head</span>(dat1l2,<span class="dv">15</span>)</code></pre></div>
<pre><code>   Year      Crop                  Country    Yield
1  2012    Barley                   Canada 38894.66
2  2012     Maize                   Canada 83611.49
3  2012      Oats                   Canada 24954.79
4  2012       Rye                   Canada 38056.86
5  2012    Barley United States of America 36533.24
6  2012 Buckwheat United States of America 10445.86
7  2012     Maize United States of America 77441.67
8  2012      Oats United States of America 21974.70
9  2012       Rye United States of America 17575.73
10 2011    Barley                   Canada 32796.43
11 2011     Maize                   Canada 88946.49
12 2011      Oats                   Canada 29109.36
13 2011       Rye                   Canada 24676.81
14 2011    Barley United States of America 37431.96
15 2011 Buckwheat United States of America 10299.05</code></pre>
</div>
<div id="dataset-dat2" class="section level2">
<h2>Dataset <code>dat2</code></h2>
<div id="a-tidy-table-dat2b" class="section level3">
<h3>A tidy table: <code>dat2b</code></h3>
<p><code>dat2</code> consists of county income and educational attainment for both the male and female population. A codebook <a href="http://mgimond.github.io/ES218/Data/Income_education_codebook.csv">available here</a> provides descriptions for the different codes. We will remove the cases (rows) from <code>dat2</code> for which values are missing (i.e. cases having a <code>NA</code> designation) since these rows will serve no purpose (such cases may be associated with counties having no year-round residents or a resident population too small for data dissemination).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat2 &lt;-<span class="st"> </span><span class="kw">na.omit</span>(dat2)</code></pre></div>
<p>As with <code>dat1</code>, we will create a tidy version of <code>dat2</code> for use with packages such as <code>ggplot2</code>.</p>
<p>The <code>dat2</code> dataset has income data broken down by educational attainment and gender aggregated at the county level. It would therefore be convenient for plot operations if two variables, <code>Gender</code> and (educational) <code>Level</code>, were added to the long table version of <code>dat2</code>.</p>
<div class="figure">
<img src="img/Census_table_1.png" />

</div>
<p>We will first generate a lookup table, <code>Edu.Gend</code>, of variable elements that will match each census category (e.g. <code>B20004001</code>, <code>B20004002</code>, …) to its matching pair of <code>Level</code> and <code>Gender</code> types.</p>
<p>We will also create a State/Region lookup table, <code>st.reg</code>, that will store two variables: the two letter state abbreviation variable <code>State</code> and its matching region variable <code>Region</code>. R has a built-in vector called <code>state.region</code> that assigns a region to each state. However, you’ll note that this vector only has region names but makes no reference to states. It’s intended to be used with another built-in data vector called <code>state.abb</code> or <code>state.name</code>. We will combine <code>state.abb</code> with <code>state.region</code> to create <code>st.reg</code>. We will also need to convert the uppercase state abbreviations to lower case using <code>tolower</code> so that they match the <code>dat2</code>’s lowercase state abbreviations. Note that D.C. is not included in the built-in states dataset, so we will add this record the <code>st.reg</code> table and assign D.C. to the <code>South</code> region.</p>
<p>Finally, the two tables, <code>Edu.gend</code> and <code>st.reg</code>, will be joined to the long version of <code>dat2</code> such that each observation will be assigned a <code>Level</code>, <code>Gender</code> and <code>Region</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(stringr)
<span class="co"># Create a variable/Level/Gender join table</span>
Edu.Gend &lt;-<span class="st"> </span><span class="kw">data.frame</span>( 
               <span class="dt">variable   =</span> <span class="kw">paste</span>(<span class="st">&quot;B200040&quot;</span>, <span class="kw">str_pad</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">18</span>, <span class="dt">width=</span><span class="dv">2</span> , <span class="dt">pad=</span><span class="st">&quot;0&quot;</span>),<span class="dt">sep=</span><span class="st">&quot;&quot;</span> ),
               <span class="dt">Level      =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;All&quot;</span>, <span class="st">&quot;NoHS&quot;</span>,<span class="st">&quot;HS&quot;</span>,<span class="st">&quot;AD&quot;</span>,<span class="st">&quot;BD&quot;</span>,<span class="st">&quot;Grad&quot;</span>), <span class="dt">times=</span><span class="dv">3</span>),
               <span class="dt">Gender     =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;All&quot;</span>, <span class="st">&quot;M&quot;</span>,<span class="st">&quot;F&quot;</span>), <span class="dt">each=</span><span class="dv">6</span>) )

<span class="co"># Create a region/state join table</span>
st.reg &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">State =</span> <span class="kw">tolower</span>(state.abb), <span class="dt">Region =</span> state.region)
st.reg &lt;-<span class="st"> </span><span class="kw">rbind</span>(st.reg , <span class="kw">data.frame</span>(<span class="dt">State=</span><span class="st">&quot;dc&quot;</span>, <span class="dt">Region=</span><span class="st">&quot;South&quot;</span>) )

<span class="co"># Start the piping operations</span>
dat2b &lt;-<span class="st"> </span>dat2 <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> <span class="st">&quot;variable&quot;</span>, <span class="dt">value =</span> <span class="st">&quot;value&quot;</span>, <span class="op">-</span><span class="dv">1</span><span class="op">:-</span><span class="dv">2</span>)  <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(Edu.Gend, <span class="dt">by=</span><span class="st">&quot;variable&quot;</span> )              <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(State, County, Level, Gender, value)       <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Level =</span> <span class="kw">factor</span>(Level, 
                        <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;All&quot;</span>,<span class="st">&quot;NoHS&quot;</span>,<span class="st">&quot;HS&quot;</span>, <span class="st">&quot;AD&quot;</span>, <span class="st">&quot;BD&quot;</span>, <span class="st">&quot;Grad&quot;</span>))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(st.reg , <span class="dt">by=</span><span class="st">&quot;State&quot;</span>)
<span class="kw">head</span>(dat2b)</code></pre></div>
<pre><code>  State  County Level Gender value Region
1    al Autauga   All    All 35881  South
2    al Baldwin   All    All 31439  South
3    al Barbour   All    All 25201  South
4    al    Bibb   All    All 29016  South
5    al  Blount   All    All 32035  South
6    al Bullock   All    All 26408  South</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tail</span>(dat2b)</code></pre></div>
<pre><code>      State     County Level Gender value Region
55201    wy   Sublette  Grad      F 59683   West
55202    wy Sweetwater  Grad      F 63681   West
55203    wy      Teton  Grad      F 48357   West
55204    wy      Uinta  Grad      F 52321   West
55205    wy   Washakie  Grad      F 50341   West
55206    wy     Weston  Grad      F 56765   West</code></pre>
<p>Note that we have eliminated references to variable names such as “B20004001” from <code>dat2b</code> making it easier to interpret the variable names/values. Also note that we have re-leveled the educational attainment factor <code>Level</code> to reflect the implied order in educational attainment levels.</p>
</div>
<div id="spreading-gender-across-columns-dat2c" class="section level3">
<h3>Spreading gender across columns: <code>dat2c</code></h3>
<p>In <code>dat2b</code> the gender values are lumped under the variable called <code>Gender</code>. In some upcoming lectures, we will want to compare male and female incomes requiring that they be assigned their own columns. We will therefore <em>widen</em> <code>dat2b</code>. We will use the <code>spread</code> function from the <code>tidyr</code> package to create a new data frame called <code>dat2c</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat2c &lt;-<span class="st"> </span><span class="kw">spread</span>(dat2b, <span class="dt">key =</span> Gender, <span class="dt">value =</span> value )

<span class="kw">head</span>(dat2c)</code></pre></div>
<pre><code>  State                 County Level Region   All     F     M
1    ak Aleutians East Borough   All   West 21953 20164 22940
2    ak Aleutians East Borough  NoHS   West 21953 19250 22885
3    ak Aleutians East Borough    HS   West 20770 19671 21192
4    ak Aleutians East Borough    AD   West 26383 26750 26352
5    ak Aleutians East Borough    BD   West 22431 19592 27875
6    ak Aleutians East Borough  Grad   West 74000 74000 71250</code></pre>
</div>
</div>


<div class="footer">
<hr/>
<a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>  Manny Gimond (2019)
</br>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
