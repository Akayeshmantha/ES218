<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Mapping variables</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #0000ff; } /* Keyword */
code > span.ch { color: #008080; } /* Char */
code > span.st { color: #008080; } /* String */
code > span.co { color: #008000; } /* Comment */
code > span.ot { color: #ff4000; } /* Other */
code > span.al { color: #ff0000; } /* Alert */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #008000; font-weight: bold; } /* Warning */
code > span.cn { } /* Constant */
code > span.sc { color: #008080; } /* SpecialChar */
code > span.vs { color: #008080; } /* VerbatimString */
code > span.ss { color: #008080; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { } /* Variable */
code > span.cf { color: #0000ff; } /* ControlFlow */
code > span.op { } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #ff4000; } /* Preprocessor */
code > span.do { color: #008000; } /* Documentation */
code > span.an { color: #008000; } /* Annotation */
code > span.cv { color: #008000; } /* CommentVar */
code > span.at { } /* Attribute */
code > span.in { color: #008000; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="libs\style.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Data Manipulation
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 02</li>
    <li>
      <a href="Week02a.html">Data types</a>
    </li>
    <li>
      <a href="Week02b.html">Reading and writing data files</a>
    </li>
    <li>
      <a href="Week02c.html">Working with date objects</a>
    </li>
    <li>
      <a href="Week02d.html">Exploring and cleaning dataframes using base functions</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 03</li>
    <li>
      <a href="Week03a.html">Manipulating dataframes with dplyr</a>
    </li>
    <li>
      <a href="Week03b.html">Tidying/reshaping tables using tidyr</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 04</li>
    <li>
      <a href="Week03c.html">Joining data tables</a>
    </li>
    <li>
      <a href="Week03d.html">Working with string objects</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Plots
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 05</li>
    <li>
      <a href="Week04a.html">The base plotting environment</a>
    </li>
    <li>
      <a href="Week04b.html">The lattice plotting environment</a>
    </li>
    <li>
      <a href="Week04c.html">The ggplot plotting environment</a>
    </li>
    <li>
      <a href="Week04d.html">Manipulating colors in R</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Univariate
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 06</li>
    <li>
      <a href="Week05a.html">Visualizing univariate data</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 07</li>
    <li>
      <a href="Week05b.html">Comparing univariate data distributions</a>
    </li>
    <li>
      <a href="Week06a.html">Theoretical Q-Q plot</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 08</li>
    <li>
      <a href="Week07a.html">Fits and residuals</a>
    </li>
    <li>
      <a href="Week07b.html">Spread-location plot</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 09</li>
    <li>
      <a href="Week08a.html">Re-expressing data</a>
    </li>
    <li>
      <a href="Week08b.html">Letter value summaries</a>
    </li>
    <li>
      <a href="Week08c.html">The Two R’s of EDA</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Bivariate
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 10</li>
    <li>
      <a href="Week09a.html">Bivariate analysis</a>
    </li>
    <li>
      <a href="Week09b.html">Resistant lines</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 11</li>
    <li>
      <a href="Week10a.html">The third R of EDA: Residuals</a>
    </li>
    <li>
      <a href="Week10b.html">Detecting discontinuities in the data</a>
    </li>
    <li>
      <a href="http://mgimond.github.io/Stats-in-R/regression.html">Details of the OLS regression method (optional reading)</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Two-way tables
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 12</li>
    <li>
      <a href="Week11a.html">Median polish/Mean polish</a>
    </li>
    <li>
      <a href="http://mgimond.github.io/Stats-in-R/ANOVA.html">Details of an ANOVA (optional reading)</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Misc
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 13</li>
    <li>
      <a href="Week12a.html">Creating maps in R</a>
    </li>
    <li class="dropdown-header">Connecting to relational databases</li>
  </ul>
</li>
<li>
  <a href="Data.html">Datasets</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Mapping variables</h1>

</div>

<div id="TOC">
<ul>
<li><a href="#using-the-maps-package">Using the <code>maps</code> package</a><ul>
<li><a href="#generating-a-basic-map">Generating a basic map</a></li>
<li><a href="#joining-income-table-to-the-map-by-county-and-state-names">Joining income table to the map by county and state names</a></li>
<li><a href="#joining-income-table-by-fips-code">Joining income table by FIPS code</a></li>
</ul></li>
<li><a href="#working-with-external-gis-files">Working with external GIS files</a><ul>
<li><a href="#reading-a-shapefile-into-r">Reading a shapefile into R</a></li>
<li><a href="#generating-a-continuous-color-scheme">Generating a continuous color scheme</a></li>
<li><a href="#generating-a-discrete-color-scheme">Generating a discrete color scheme</a></li>
<li><a href="#generating-a-divergent-color-scheme">Generating a divergent color scheme</a></li>
</ul></li>
</ul>
</div>

<p>Variables can be mapped in R using readily available CRAN packages such as <code>rgdal</code> and <code>maps</code>. The focus of this tutorial will be on mapping polygon vector (aka areal) data and not on raster (aka field) data.</p>
<div id="using-the-maps-package" class="section level1">
<h1>Using the <code>maps</code> package</h1>
<div id="generating-a-basic-map" class="section level2">
<h2>Generating a basic map</h2>
<p>Mapping values requires two datasets: the values to be mapped and the spatial boundaries of the areas being mapped. The <code>maps</code> package offers R-ready maps for US states/counties and administrative boundaries for other countries such as Canada, France and Italy.</p>
<p>In the following example we will use <code>ggplot</code> to draw the US counties map. We will also color the counties based on the state they are located in. The state name column is labeled <code>region</code> and the county name column is labeled <code>subregion</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(maps)

<span class="co"># Load the county data from the maps package</span>
cnty &lt;-<span class="st"> </span><span class="kw">map_data</span>(<span class="st">&quot;county&quot;</span>)

<span class="co"># Plot the counties</span>
<span class="kw">ggplot</span>(cnty, <span class="kw">aes</span>(long,lat, <span class="dt">group =</span> group)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> region), <span class="dt">colour =</span> <span class="kw">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.2</span>)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">&quot;none&quot;</span>) +
<span class="st">  </span><span class="kw">coord_quickmap</span>()</code></pre></div>
<p><img src="Week12a_files/figure-html/unnamed-chunk-2-1.png" width="624" /></p>
<p>The <code>x</code> and <code>y</code> values are assigned the <code>long</code> and <code>lat</code> columns that store the coordinate values for each vertex that delineates a county. The <code>group</code> parameter tells <code>ggplot</code> which polygon (county) a vertex is defining. The <code>geom_polygon()</code> function generates <em>filled</em> areas from those vertices. The <code>colour</code> parameter defines the polygon outline color. The option <code>legend.position=&quot;none&quot;</code> prevents the legend from being displayed and the <code>coord_quickmap()</code> function forces the aspect ratio to approximate that of the Mercator projection.</p>
<p>If you want to change the map projection, you can substitute <code>coord_quickmap()</code> with <code>coord_map()</code>. The latter accepts as parameter projections available in the the <code>mapproj</code> package. For example, to project the continental US into a Bonne projection modify the above chunk as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(cnty, <span class="kw">aes</span>(long,lat, <span class="dt">group =</span> group)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> region), <span class="dt">colour =</span> <span class="kw">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.2</span>)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">&quot;none&quot;</span>) +
<span class="st">  </span><span class="kw">coord_map</span>(<span class="st">&quot;bonne&quot;</span>,  <span class="dt">param=</span><span class="dv">45</span>) </code></pre></div>
<p><img src="Week12a_files/figure-html/unnamed-chunk-3-1.png" width="624" /></p>
<p>If we want to omit the background grid, we modify the chunk as follows (note that the <code>theme()</code> options gets overridden by the <code>theme_void()</code> option requiring that we pass the <code>show.legend = FALSE</code> option to <code>geom_polygon</code>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(cnty, <span class="kw">aes</span>(long,lat, <span class="dt">group =</span> group)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> region), <span class="dt">show.legend =</span> <span class="ot">FALSE</span>, <span class="dt">colour =</span> <span class="kw">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.2</span>)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">coord_map</span>(<span class="st">&quot;bonne&quot;</span>,  <span class="dt">param=</span><span class="dv">45</span>) +
<span class="st">  </span><span class="kw">theme_void</span>()</code></pre></div>
<p><img src="Week12a_files/figure-html/unnamed-chunk-4-1.png" width="624" /></p>
</div>
<div id="joining-income-table-to-the-map-by-county-and-state-names" class="section level2">
<h2>Joining income table to the map by county and state names</h2>
<p>The next step is to <em>join</em> a dataset to the counties map. We will use the income-by-gender-education dataset used earlier in the course and limit the data to <em>median income per person</em> (<code>B20004001</code> column).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
df &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;http://mgimond.github.io/ES218/Data/Income_education.csv&quot;</span>)
df1 &lt;-<span class="st"> </span>df %&gt;%<span class="st"> </span><span class="kw">select</span>(<span class="dt">subregion=</span>County, <span class="dt">region=</span>State, B20004001 )</code></pre></div>
<p>Next, we need to join the census data to the county map using <em>two</em> columns: state name and county name (or <code>region</code> and <code>subregion</code> columns). Let’s compare the two dataframes by viewing the first few rows of each.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(cnty)</code></pre></div>
<pre><code>       long      lat group order  region subregion
1 -86.50517 32.34920     1     1 alabama   autauga
2 -86.53382 32.35493     1     2 alabama   autauga
3 -86.54527 32.36639     1     3 alabama   autauga
4 -86.55673 32.37785     1     4 alabama   autauga
5 -86.57966 32.38357     1     5 alabama   autauga
6 -86.59111 32.37785     1     6 alabama   autauga</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(df1)</code></pre></div>
<pre><code>  subregion region B20004001
1   Autauga     al     35881
2   Baldwin     al     31439
3   Barbour     al     25201
4      Bibb     al     29016
5    Blount     al     32035
6   Bullock     al     26408</code></pre>
<p>We note two problems. first, the <code>cnty</code> object encodes states using their full name and not their two letter abbreviation. Second, the county names in <code>cnty</code> are in <em>all</em> lower case. Before attempting to join the dataframes, we must first fix these discrepancies. We will choose to modify <code>df</code> so that its state and county names match those in the <code>cnty</code> (map) dataframe.</p>
<p>We will first create a state name/abbreviation look-up table using the built-in <code>state.name</code> and <code>state.abb</code> objects. Note that using these pre-existing objects will require that we add the District of Columbia to the table since it’s not present in either data objects.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">region=</span><span class="kw">tolower</span>(state.name), <span class="dt">State =</span> <span class="kw">tolower</span>(state.abb))
st &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(st, <span class="kw">data.frame</span>(<span class="dt">region=</span><span class="st">&quot;district of columbia&quot;</span>, <span class="dt">State=</span><span class="st">&quot;dc&quot;</span>) )</code></pre></div>
<p>Next, we join the <code>st</code> look-up table to <code>df</code> then make the additional changes needed to join the census data to the counties map. Note that we are overwriting the earlier instance of <code>df1</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df1 &lt;-<span class="st"> </span>df %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">inner_join</span>(st, <span class="dt">by=</span><span class="st">&quot;State&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">subregion =</span> <span class="kw">tolower</span>(County))  %&gt;%
<span class="st">  </span><span class="kw">select</span>(subregion, region, B20004001 )</code></pre></div>
<p>We can now join <code>df1</code> to <code>cnty</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cnty.df1 &lt;-<span class="st"> </span><span class="kw">inner_join</span>(cnty, df1, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;region&quot;</span>, <span class="st">&quot;subregion&quot;</span>) )</code></pre></div>
<p>Now let’s map the income distribution.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(cnty.df1, <span class="kw">aes</span>(long, lat,<span class="dt">group =</span> group)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> B20004001), <span class="dt">colour =</span> <span class="kw">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.2</span>))  +
<span class="st">  </span><span class="kw">coord_quickmap</span>()</code></pre></div>
<p><img src="Week12a_files/figure-html/unnamed-chunk-10-1.png" width="720" /></p>
<p>You may notice that the counties map does not seem complete; most notable is the absence of <em>all</em> Louisiana counties. Let’s look at the rows in <code>cnty.df1</code> associated with the state of Louisiana.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">filter</span>(cnty.df1, region ==<span class="st"> &quot;louisiana&quot;</span>)</code></pre></div>
<pre><code>[1] long      lat       group     order     region    subregion B20004001
&lt;0 rows&gt; (or 0-length row.names)</code></pre>
<p>There are no rows returned. This suggests that the Louisiana counties did not properly join. Let’s compare the Louisiana county names between <code>df1</code> and <code>cnty</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df1 %&gt;%<span class="st"> </span><span class="kw">filter</span>(region ==<span class="st"> &quot;louisiana&quot;</span>) %&gt;%<span class="st"> </span><span class="kw">select</span>(subregion)</code></pre></div>
<pre><code>                     subregion
1                acadia parish
2                 allen parish
3             ascension parish
4            assumption parish
5             avoyelles parish
6            beauregard parish
7             bienville parish
8               bossier parish
9                 caddo parish
10            calcasieu parish
11             caldwell parish
12              cameron parish
13            catahoula parish
14            claiborne parish
15            concordia parish
16              de soto parish
17     east baton rouge parish
18         east carroll parish
19       east feliciana parish
20           evangeline parish
21             franklin parish
22                grant parish
23               iberia parish
24            iberville parish
25              jackson parish
26            jefferson parish
27      jefferson davis parish
28            lafayette parish
29            lafourche parish
30              lasalle parish
31              lincoln parish
32           livingston parish
33              madison parish
34            morehouse parish
35         natchitoches parish
36              orleans parish
37             ouachita parish
38          plaquemines parish
39        pointe coupee parish
40              rapides parish
41            red river parish
42             richland parish
43               sabine parish
44          st. bernard parish
45          st. charles parish
46           st. helena parish
47            st. james parish
48 st. john the baptist parish
49           st. landry parish
50           st. martin parish
51             st. mary parish
52          st. tammany parish
53           tangipahoa parish
54               tensas parish
55           terrebonne parish
56                union parish
57            vermilion parish
58               vernon parish
59           washington parish
60              webster parish
61     west baton rouge parish
62         west carroll parish
63       west feliciana parish
64                 winn parish</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cnty %&gt;%<span class="st"> </span><span class="kw">filter</span>(region ==<span class="st"> &quot;louisiana&quot;</span>) %&gt;%<span class="st"> </span><span class="kw">select</span>(subregion) %&gt;%<span class="st"> </span><span class="kw">unique</span>()</code></pre></div>
<pre><code>               subregion
1                 acadia
45                 allen
67             ascension
106           assumption
145            avoyelles
211           beauregard
243            bienville
279              bossier
372                caddo
461            calcasieu
493             caldwell
527              cameron
568            catahoula
666            claiborne
686            concordia
791              de soto
847     east baton rouge
897         east carroll
950       east feliciana
978           evangeline
1021            franklin
1098               grant
1145              iberia
1203           iberville
1258             jackson
1274           jefferson
1340     jefferson davis
1382           lafayette
1430           lafourche
1498            la salle
1547             lincoln
1573          livingston
1619             madison
1687           morehouse
1737        natchitoches
1823             orleans
1888            ouachita
1922         plaquemines
2044       pointe coupee
2118             rapides
2205           red river
2248            richland
2306              sabine
2354          st bernard
2435          st charles
2474           st helena
2493            st james
2515 st john the baptist
2551           st landry
2596           st martin
2681             st mary
2752          st tammany
2797          tangipahoa
2835              tensas
2906          terrebonne
2982               union
3009           vermilion
3070              vernon
3117          washington
3137             webster
3174    west baton rouge
3213        west carroll
3253      west feliciana
3307                winn</code></pre>
<p>It turns out that Louisiana does not divide its administrative areas into <em>counties</em> but <em>parishes</em> instead. The income data (originally downloaded from the Census Bureau) follows through with that designation convention by adding the word “parish” to each of its administrative area names. We therefore need to remove all instances of <code>parish</code> in the <code>subregion</code> names associated with Louisiana. We will therefore need to recreate the <code>df1</code> object:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(stringr)
df1 &lt;-<span class="st"> </span>df %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">inner_join</span>(st, <span class="dt">by=</span><span class="st">&quot;State&quot;</span>) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>( <span class="dt">subregion =</span> <span class="kw">tolower</span>(County) ,
          <span class="dt">subregion =</span> <span class="kw">ifelse</span>(region==<span class="st">&quot;louisiana&quot;</span>, 
                             <span class="kw">str_replace</span>(subregion, <span class="st">&quot; parish&quot;</span>, <span class="st">&quot;&quot;</span>), subregion))  %&gt;%
<span class="st">  </span><span class="kw">select</span>(subregion, region, B20004001 )</code></pre></div>
<p>Let’s re-join the dataframes and re-plot the map.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cnty.df1 &lt;-<span class="st"> </span><span class="kw">inner_join</span>(cnty, df1, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;region&quot;</span>, <span class="st">&quot;subregion&quot;</span>) )

<span class="kw">ggplot</span>(cnty.df1, <span class="kw">aes</span>(long, lat,<span class="dt">group =</span> group)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> B20004001), <span class="dt">colour =</span> <span class="kw">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.2</span>))  +
<span class="st">  </span><span class="kw">coord_quickmap</span>()</code></pre></div>
<p><img src="Week12a_files/figure-html/unnamed-chunk-14-1.png" width="720" /></p>
<p>Most of Louisiana’s parishes are now mapped, but we are still missing a few parishes as well as a few counties. This is a result of differences in spelling for two-word county and parish names. For example, <code>df1</code> encodes St. Lucie county (Florida) as <code>st. lucie</code> whereas <code>cnty</code> omits the dot and encodes it as <code>st lucie</code>. Fixing these discrepancies will require additional labor. At this point, it may prove more fruitful to do away with state/county names as <em>joining</em> keys and use <strong>FIPS</strong> county codes instead. FIPS (Federal Information Processing Standards) codes assign each county/state a unique five number designation thus making it easier to join data to spatial features. However, neither our census data table nor the built-in counties map have FIPS codes. We will download another version of the income data (one that has FIPS codes). Note that FIPS codes are normally part of datasets provided by the Census Bureau. The <code>maps</code> package has a dataset called <code>county.fips</code> that can be used to match state/county names in the <code>county</code> map to FIPS codes.</p>
</div>
<div id="joining-income-table-by-fips-code" class="section level2">
<h2>Joining income table by FIPS code</h2>
<p>Let’s download the FIPS version of the dataset. Note that we will not need to modify/add columns to the data since we will be joining this table to the county map using the FIPS code.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;http://mgimond.github.io/ES218/Data/Income_education_with_FIPS.csv&quot;</span>)
df1 &lt;-<span class="st"> </span>df %&gt;%<span class="st"> </span><span class="kw">select</span>(FIPS, B20004001 )</code></pre></div>
<p>Next, we’ll load the <code>county.fips</code> dataset.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Load the county.fips dataset</span>
<span class="kw">data</span>(county.fips)
<span class="kw">head</span>(county.fips)</code></pre></div>
<pre><code>  fips        polyname
1 1001 alabama,autauga
2 1003 alabama,baldwin
3 1005 alabama,barbour
4 1007    alabama,bibb
5 1009  alabama,blount
6 1011 alabama,bullock</code></pre>
<p>Note that the state and county names are aggregated into a single column; this does not match the data structure in <code>cnty</code> where states and counties are stored in separate columns. This will require some minor data prepping.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cnty2 &lt;-<span class="st"> </span>cnty %&gt;%
<span class="st">        </span><span class="kw">mutate</span>(<span class="dt">polyname =</span> <span class="kw">paste</span>(region,subregion,<span class="dt">sep=</span><span class="st">&quot;,&quot;</span>)) %&gt;%
<span class="st">        </span><span class="kw">left_join</span>(county.fips, <span class="dt">by=</span><span class="st">&quot;polyname&quot;</span>)</code></pre></div>
<p>Now that the FIPS codes are part of the county map dataframe, let’s join the income data table to the county map, then map the income values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cnty2.df1 &lt;-<span class="st"> </span><span class="kw">inner_join</span>(cnty2, df1, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;fips&quot;</span> =<span class="st"> &quot;FIPS&quot;</span>) )

<span class="kw">ggplot</span>(cnty2.df1, <span class="kw">aes</span>(long, lat,<span class="dt">group =</span> group)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> B20004001), <span class="dt">colour =</span> <span class="kw">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.2</span>))  +
<span class="st">  </span><span class="kw">coord_quickmap</span>()</code></pre></div>
<p><img src="Week12a_files/figure-html/unnamed-chunk-18-1.png" width="720" /></p>
<p>This is an improvement over the last map. But there are still a few counties missing. After a closer scrutiny of the data, it seems that the <code>county.fips</code> table splits some counties into two or more sub-regions. For example, Accomack county (Virginia) is split into two regions (and thus into two different names):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">county.fips %&gt;%<span class="st"> </span><span class="kw">filter</span>( <span class="kw">grepl</span>(<span class="st">&quot;^virginia,accomack&quot;</span>, polyname) )</code></pre></div>
<pre><code>   fips                       polyname
1 51001         virginia,accomack:main
2 51001 virginia,accomack:chincoteague</code></pre>
<p>Fixing these discrepancies would require manual intervention and time. Another work around is to use the Census Bureau’s map files instead of <code>maps</code>’s built-in map. We will cover this in the next section.</p>
</div>
</div>
<div id="working-with-external-gis-files" class="section level1">
<h1>Working with external GIS files</h1>
<div id="reading-a-shapefile-into-r" class="section level2">
<h2>Reading a shapefile into R</h2>
<p>The Census Bureau maintains its own library of administrative boundary shapefiles (shapefiles are popular map data formats). This may prove to be the best map source to use since its areal units are designed to match the records in the income data table. Loading a shapefile can easily be accomplished using the <code>readOGR()</code> function from the <code>rgdal</code> package. One option is to download the shapefile from the Census Bureau’s website (usually in a zipped format) then unpack it in a local project folder before reading it into the current session with <code>readOGR()</code>. But we can maximize the replicability of the workflow by writing a chunk of code that will download the zipped shapefile into a temporary directory before unzipping it and loading the shapefile into an active R session as shown below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rgdal)

tmp &lt;-<span class="st"> </span><span class="kw">tempdir</span>()
link &lt;-<span class="st"> &quot;http://www2.census.gov/geo/tiger/GENZ2010/gz_2010_us_050_00_20m.zip&quot;</span>
filename &lt;-<span class="st"> </span><span class="kw">basename</span>(link)
<span class="kw">download.file</span>(link, filename)
<span class="kw">unzip</span>(filename, <span class="dt">exdir =</span> tmp )
shapefile &lt;-<span class="st"> </span><span class="kw">readOGR</span>( <span class="dt">dsn=</span>tmp, <span class="dt">layer =</span> tools::<span class="kw">file_path_sans_ext</span>(filename) )</code></pre></div>
<pre><code>OGR data source with driver: ESRI Shapefile 
Source: &quot;C:\Users\mgimond\AppData\Local\Temp\RtmpEfNfGK&quot;, layer: &quot;gz_2010_us_050_00_20m&quot;
with 3221 features
It has 6 fields</code></pre>
<p>The shapefile is unzipped into a temporary folder, <code>tmp</code>, then read from that same directory and stored in a <code>SpatialPolygonsDataFrame</code> object called <code>shapefile</code>. The chunk <code>tools::file_path_sans_ext(filename)</code> extracts the name of the zip file (minus the extension) which turns out to also be the name of the shapefile. Note that if the zip file was manually unpacked in a project folder then the only command that would have needed to be executed is the <code>readOGR</code> function as in <code>readOGR( dsn=&quot;../Data&quot;, layer = &quot;gz_2010_us_050_00_20m&quot; )</code> where the <code>dsn=</code> parameter points to the directory where the shapefile resides. Note too that the shapefile’s extension is omitted from the name passed to the <code>layer=</code> parameter.</p>
<p>The Census shapefile has a field called <code>GEO_ID</code> that includes the county FIPS codes along with other superfluous county ID values. We only need the five digit county FIPS code so we’ll extract these codes into a new column called <code>FIPS</code>. We will also assign a unique ID value to each row of the dataset for use in a subsequent <code>fortify()</code> function call.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">shapefile$FIPS &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">substr</span>(shapefile$GEO_ID, <span class="dv">10</span>, <span class="dv">14</span>))
shapefile$id   &lt;-<span class="st"> </span><span class="kw">rownames</span>(shapefile@data)</code></pre></div>
<p>To plot the shapefile in <code>ggplot</code>, we need to convert the <code>SpatialPolygonsDataFrame</code> object to a dataframe using the <code>fortify()</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cnty2 &lt;-<span class="st"> </span><span class="kw">fortify</span>(shapefile, <span class="dt">id=</span><span class="st">&quot;id&quot;</span>)</code></pre></div>
<p>Next we can append the income table to the new <code>cnty2</code> object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cnty2.cs &lt;-<span class="st"> </span>cnty2 %&gt;%
<span class="st">            </span><span class="kw">inner_join</span>(shapefile@data, <span class="dt">by=</span><span class="st">&quot;id&quot;</span>) %&gt;%
<span class="st">            </span><span class="kw">inner_join</span>(df1, <span class="dt">by=</span><span class="st">&quot;FIPS&quot;</span>)</code></pre></div>
</div>
<div id="generating-a-continuous-color-scheme" class="section level2">
<h2>Generating a continuous color scheme</h2>
<p>Now we can plot the income distribution map.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(cnty2.cs, <span class="kw">aes</span>(long, lat,<span class="dt">group =</span> group)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> B20004001), <span class="dt">colour =</span> <span class="kw">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.2</span>))  +
<span class="st">  </span><span class="kw">coord_quickmap</span>() +<span class="st"> </span><span class="kw">xlim</span>(-<span class="dv">125</span>, -<span class="st"> </span><span class="dv">67</span>) +<span class="st"> </span><span class="kw">ylim</span>( <span class="dv">25</span>,<span class="dv">50</span> )</code></pre></div>
<p><img src="Week12a_files/figure-html/unnamed-chunk-24-1.png" width="720" /></p>
<p>Depending on the size of your output extent, you might find the county outlines distracting–especially in the northeastern region where the county sizes are so small. We can omit the outline by setting the <code>colour</code> parameter to <code>NA</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(cnty2.cs, <span class="kw">aes</span>(long, lat,<span class="dt">group =</span> group)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> B20004001), <span class="dt">colour =</span> <span class="ot">NA</span>)  +
<span class="st">  </span><span class="kw">coord_quickmap</span>() +<span class="st"> </span><span class="kw">xlim</span>(-<span class="dv">125</span>, -<span class="st"> </span><span class="dv">67</span>) +<span class="st"> </span><span class="kw">ylim</span>( <span class="dv">25</span>,<span class="dv">50</span> ) </code></pre></div>
<p><img src="Week12a_files/figure-html/unnamed-chunk-25-1.png" width="720" /></p>
<p><code>ggplot</code> defaults to a <strong>continuous</strong> color scheme that ranges from a dark blue to a light blue. Continuous color schemes can be modified in ggplot by using the <code>scale_fill_gradient</code> function. For example, to use a light yellow to dark green color scheme modify the above chunk of code as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(cnty2.cs, <span class="kw">aes</span>(long, lat,<span class="dt">group =</span> group)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> B20004001), <span class="dt">colour =</span> <span class="ot">NA</span>)  +
<span class="st">  </span><span class="kw">coord_quickmap</span>() +<span class="st"> </span><span class="kw">xlim</span>(-<span class="dv">125</span>, -<span class="st"> </span><span class="dv">67</span>) +<span class="st"> </span><span class="kw">ylim</span>( <span class="dv">25</span>,<span class="dv">50</span> ) +
<span class="st">  </span><span class="kw">scale_fill_gradient</span>(<span class="dt">low=</span><span class="st">&quot;lightyellow2&quot;</span>, <span class="dt">high=</span><span class="st">&quot;darkgreen&quot;</span>)</code></pre></div>
<p><img src="Week12a_files/figure-html/unnamed-chunk-26-1.png" width="720" /></p>
<p>To see a list of available color names in R, type <code>colours()</code> at the console.</p>
</div>
<div id="generating-a-discrete-color-scheme" class="section level2">
<h2>Generating a discrete color scheme</h2>
<p>You can also create a <strong>discrete</strong> color scheme–i.e. one where the number of colors are fixed by a finite set of income value intervals. For example, to split the income values across six intervals (e.g. $0 to $20000, $20000 to $30000, $30000 to $40000, $40000 to $50000 , $50000 to $60000 and $60000 to $75000) we can use the <code>cut()</code> function to assign each income value in the table to one of the intervals, then add that interval value to the <code>ctny2.cs</code> map data frame object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">interv &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">20000</span>,<span class="dv">30000</span>, <span class="dv">40000</span>,<span class="dv">50000</span>, <span class="dv">60000</span>, <span class="dv">75000</span>)

cnty2.cs$Income &lt;-<span class="st"> </span><span class="kw">cut</span>(cnty2.cs$B20004001, <span class="dt">breaks =</span> interv , <span class="dt">labels =</span> <span class="kw">paste</span>(interv[-<span class="dv">1</span>]))</code></pre></div>
<p>The <code>labels=</code> parameter allows us to define the output interval names. Here we assign the interval’s top dollar value to the interval names. Note that we could have created fancier intervals such as <code>$0 to $20k</code>, <code>$20k to $30k</code>, etc…</p>
<p>Next we’ll map the data, but first we need to change the coloring scheme since we are now using a <em>discrete</em> color scheme as opposed to a <em>continuous</em> one. Cynthia Brewer of Penn State designed a website called <a href="http://colorbrewer2.org/" class="uri">http://colorbrewer2.org/</a> that recommends discrete color schemes to use for different map effects. Defining the colors, especially for a sequential color scheme where the hue is kept constant while its lightness level is modified, is not trivial. Fortunately, her color scheme recommendations are available in <code>ggplot</code> via the <code>scale_fill_brewer()</code> function. To see a list of Brewer color schemes, simply type <code>display.brewer.all()</code> in the console window. Note that we will need to load the <code>RColorBrewer</code> package first.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(RColorBrewer)

<span class="kw">display.brewer.all</span>()</code></pre></div>
<p><img src="Week12a_files/figure-html/unnamed-chunk-28-1.png" width="720" /></p>
<p>We’ll choose the <code>YlGn</code> color scheme. In case you did not run the last code chunk, we’ll load the <code>RColorBrewer</code> package once more.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(RColorBrewer)

<span class="kw">ggplot</span>(cnty2.cs, <span class="kw">aes</span>(long, lat,<span class="dt">group =</span> group)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Income), <span class="dt">colour =</span> <span class="ot">NA</span>)  +
<span class="st">  </span><span class="kw">coord_quickmap</span>() +<span class="st"> </span><span class="kw">xlim</span>(-<span class="dv">125</span>, -<span class="st"> </span><span class="dv">67</span>) +<span class="st"> </span><span class="kw">ylim</span>( <span class="dv">25</span>,<span class="dv">50</span> ) +
<span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;YlGn&quot;</span>)</code></pre></div>
<p><img src="Week12a_files/figure-html/unnamed-chunk-29-1.png" width="720" /></p>
</div>
<div id="generating-a-divergent-color-scheme" class="section level2">
<h2>Generating a divergent color scheme</h2>
<p>We might choose to map the income distribution using a <strong>divergent</strong> color scheme where we compare the counties to some overall value such as the counties’ median. We can use the <code>quantile()</code> function to break the income data into its percentiles. This will be helpful in generating symmetrical intervals about the median.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">inc.qt &lt;-<span class="st"> </span><span class="kw">quantile</span>(df1$B20004001, <span class="dt">probs =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.125</span>, .<span class="dv">25</span>, <span class="fl">0.5</span>, .<span class="dv">75</span>, .<span class="dv">875</span> , <span class="dv">1</span> ))</code></pre></div>
<p>We’ll create new income intervals centered on the median of 30767.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cnty2.cs$Income &lt;-<span class="st"> </span><span class="kw">cut</span>(cnty2.cs$B20004001, <span class="dt">breaks =</span> inc.qt , <span class="dt">labels =</span> <span class="kw">paste</span>(inc.qt[-<span class="dv">1</span>]))</code></pre></div>
<p>A divergent color scheme consists of two different hues whose lightness values converge towards some central value (the median income in our case). We’ll use Brewer’s red-to-green color palette <code>RdYlGn</code> for this next map.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(RColorBrewer)

<span class="kw">ggplot</span>(cnty2.cs, <span class="kw">aes</span>(long, lat,<span class="dt">group =</span> group)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Income), <span class="dt">colour =</span> <span class="ot">NA</span>)  +
<span class="st">  </span><span class="kw">coord_quickmap</span>() +<span class="st"> </span><span class="kw">xlim</span>(-<span class="dv">125</span>, -<span class="st"> </span><span class="dv">67</span>) +<span class="st"> </span><span class="kw">ylim</span>( <span class="dv">25</span>,<span class="dv">50</span> ) +
<span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;RdYlGn&quot;</span>)</code></pre></div>
<p><img src="Week12a_files/figure-html/unnamed-chunk-32-1.png" width="720" /></p>
<p>The divergent map gives us a different handle on the data. Here, we can identify the poorer than average regions such as the southeast and parts of the Mississippi river region as well as the wealthier regions such as the northeast (with the exception of Maine).</p>
</div>
</div>


<div class="footer">
<hr/>
<a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>  Manny Gimond (2017)
</br>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
