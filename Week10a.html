<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>CO2 analysis</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #0000ff; } /* Keyword */
code > span.ch { color: #008080; } /* Char */
code > span.st { color: #008080; } /* String */
code > span.co { color: #008000; } /* Comment */
code > span.ot { color: #ff4000; } /* Other */
code > span.al { color: #ff0000; } /* Alert */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #008000; font-weight: bold; } /* Warning */
code > span.cn { } /* Constant */
code > span.sc { color: #008080; } /* SpecialChar */
code > span.vs { color: #008080; } /* VerbatimString */
code > span.ss { color: #008080; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { } /* Variable */
code > span.cf { color: #0000ff; } /* ControlFlow */
code > span.op { } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #ff4000; } /* Preprocessor */
code > span.do { color: #008000; } /* Documentation */
code > span.an { color: #008000; } /* Annotation */
code > span.cv { color: #008000; } /* CommentVar */
code > span.at { } /* Attribute */
code > span.in { color: #008000; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="libs\style.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Data Manipulation
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 02</li>
    <li>
      <a href="Week02a.html">Data types</a>
    </li>
    <li>
      <a href="Week02b.html">Reading and writing data files</a>
    </li>
    <li>
      <a href="Week02c.html">Working with date objects</a>
    </li>
    <li>
      <a href="Week02d.html">Exploring and cleaning dataframes using base functions</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 03</li>
    <li>
      <a href="Week03a.html">Manipulating dataframes with dplyr</a>
    </li>
    <li>
      <a href="Week03d.html">Working with string objects</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 04</li>
    <li>
      <a href="Week03ab_groupby.html">Grouping and summarizing tables</a>
    </li>
    <li>
      <a href="Week03b.html">Tidying/reshaping tables using tidyr</a>
    </li>
    <li>
      <a href="Week03c.html">Joining data tables</a>
    </li>
    <li>
      <a href="Week03ab_examples.html">Example of data manipulation workflows</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Plots
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 05</li>
    <li>
      <a href="Week04a.html">The base plotting environment</a>
    </li>
    <li>
      <a href="Week04b.html">The lattice plotting environment</a>
    </li>
    <li>
      <a href="Week04c.html">The ggplot plotting environment</a>
    </li>
    <li>
      <a href="Week04d.html">Manipulating colors in R</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Univariate
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 06</li>
    <li>
      <a href="Week05a.html">Visualizing univariate data</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 07</li>
    <li>
      <a href="Week05b.html">Comparing univariate data distributions</a>
    </li>
    <li>
      <a href="Week06a.html">Theoretical Q-Q plot</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 08</li>
    <li>
      <a href="Week07a.html">Fits and residuals</a>
    </li>
    <li>
      <a href="Week07b.html">Spread-location plot</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 09</li>
    <li>
      <a href="Week08a.html">Re-expressing data</a>
    </li>
    <li>
      <a href="Week08b.html">Letter value summaries</a>
    </li>
    <li>
      <a href="Week08c.html">The Two R’s of EDA</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Bivariate
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 10</li>
    <li>
      <a href="Week09a.html">Bivariate analysis</a>
    </li>
    <li>
      <a href="Week09b.html">Resistant lines</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Week 11</li>
    <li>
      <a href="Week10a.html">The third R of EDA: Residuals</a>
    </li>
    <li>
      <a href="Week10b.html">Detecting discontinuities in the data</a>
    </li>
    <li>
      <a href="http://mgimond.github.io/Stats-in-R/regression.html">Details of the OLS regression method (optional reading)</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Two-way tables
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 12</li>
    <li>
      <a href="Week11a.html">Median polish/Mean polish</a>
    </li>
    <li>
      <a href="http://mgimond.github.io/Stats-in-R/ANOVA.html">Details of an ANOVA (optional reading)</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Misc
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Week 13</li>
    <li>
      <a href="Week12a.html">Creating maps in R</a>
    </li>
    <li class="dropdown-header">Connecting to relational databases</li>
  </ul>
</li>
<li>
  <a href="Data.html">Datasets</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->
<link href="https://fonts.googleapis.com/css?family=Open+Sans%7CSource+Code+Pro" rel="stylesheet">

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">CO2 analysis</h1>

</div>

<div id="TOC">
<ul>
<li><a href="#an-eda-example-co2-analysis">An EDA example: CO2 analysis</a></li>
<li><a href="#exploring-the-overall-trend">Exploring the overall trend</a></li>
<li><a href="#exploring-the-seasonal-component">Exploring the seasonal component</a></li>
<li><a href="#exploring-what-remains">Exploring what remains</a></li>
</ul>
</div>

<div style="color:#ff7535; background-color:#fff0ee ;   border-left-style: solid">
<p>This tutorial makes use of the following R package(s): <strong><code>tidyr</code></strong>, <strong><code>lubridate</code></strong> and <strong><code>ggplot2</code></strong>.</p>
<p>This material is intended to supplement <strong>pages 159 to 169</strong> of <strong>Cleveland’s book</strong>.</p>
</div>
<div id="an-eda-example-co2-analysis" class="section level1">
<h1>An EDA example: CO2 analysis</h1>
<p>Let’s start off by plotting the atmospheric CO2 concentrations (in ppm). The original dataset was pulled from <a href="http://www.esrl.noaa.gov/gmd/ccgg/trends/">NOAA’s website</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lubridate)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(ggplot2)

d1 &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;http://mgimond.github.io/ES218/Data/CO2.csv&quot;</span>)

d2 &lt;-<span class="st"> </span>d1 <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate</span>( <span class="dt">Date =</span> <span class="kw">ymd</span>(<span class="kw">paste</span>(Year,<span class="st">&quot;/&quot;</span>, Month,<span class="st">&quot;/15&quot;</span>)),
              <span class="dt">Year =</span> <span class="kw">as.numeric</span>(<span class="kw">decimal_date</span>(Date)),
              <span class="dt">CO2 =</span> Interpolated)    <span class="op">%&gt;%</span>
<span class="st">     </span><span class="kw">select</span>(Year, Date, CO2)</code></pre></div>
<p>Next, let’s look at the data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(d2, <span class="kw">aes</span>(<span class="dt">x=</span>Year , <span class="dt">y=</span>CO2)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>()</code></pre></div>
<p><img src="Week10a_files/figure-html/unnamed-chunk-3-1.png" width="576" /></p>
<p>Let’s see if plotting the data using lines instead of points helps identify any underlying pattern.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(d2, <span class="kw">aes</span>(<span class="dt">x=</span>Year , <span class="dt">y=</span>CO2)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</code></pre></div>
<p><img src="Week10a_files/figure-html/unnamed-chunk-4-1.png" width="576" /></p>
<p>We note two patterns of interest: an overall upward trend, and a cyclical trend. We will first <em>smooth</em> out the overall trend by finding a model that best explains the overall variability, then we’ll remove that trend from the data to explore the cyclical component.</p>
</div>
<div id="exploring-the-overall-trend" class="section level1">
<h1>Exploring the overall trend</h1>
<p>We can attempt to model the overall trend by fitting a straight line to the data using a standard regression analysis procedure. The fitted line is displayed in red in the following plot. We will use <code>ggplot2</code>’s built-in smoothing function to plot the regression line.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(d2, <span class="kw">aes</span>(<span class="dt">x=</span>Year, <span class="dt">y=</span>CO2)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">             </span><span class="kw">stat_smooth</span>(<span class="dt">method=</span><span class="st">&quot;lm&quot;</span>, <span class="dt">se=</span><span class="ot">FALSE</span>, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>) </code></pre></div>
<p><img src="Week10a_files/figure-html/unnamed-chunk-5-1.png" width="576" /></p>
<p>Next, we subtract the modeled line from the CO2 data and plot the result–this gives us the <strong>residuals</strong> and can be thought of as representing what the linear model does <em>not</em> explain about the data. But first, we will need to create a regression model object since it will provide us with the residuals needed to generate the residual plot.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Generate a model object of the regression line</span>
M1 &lt;-<span class="st"> </span><span class="kw">lm</span>(CO2 <span class="op">~</span><span class="st"> </span>Year, d2) <span class="co"># Generate model</span>

<span class="co"># Plot the residuals from the model object</span>
<span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">aes</span>(<span class="dt">x=</span>d2<span class="op">$</span>Year, <span class="dt">y=</span><span class="kw">residuals</span>(M1)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>()</code></pre></div>
<p><img src="Week10a_files/figure-html/unnamed-chunk-6-1.png" width="576" /></p>
<p>An overall trend is still present, despite having attempted to control for it. This implies that our simple line model does not do a good job in <em>smoothing</em> out the overall trend.</p>
<p>It appears that the overall trend is slightly convex and has a small peak around the 1990’s; we should try to fit the trend using a 3rd order polynomial of the form:</p>
<p><span class="math display">\[
CO2_{trend} = a + b(Year) + c(Year^2) + d(Year^3)
\]</span></p>
<p>The fitted line looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Third order polynomial</span>
M2 &lt;-<span class="st"> </span><span class="kw">lm</span>(CO2 <span class="op">~</span><span class="st"> </span>Year <span class="op">*</span><span class="st"> </span><span class="kw">I</span>(Year<span class="op">^</span><span class="dv">2</span>) <span class="op">*</span><span class="st"> </span><span class="kw">I</span>(Year<span class="op">^</span><span class="dv">3</span>), d2)
<span class="kw">ggplot</span>(d2, <span class="kw">aes</span>(<span class="dt">x=</span>Year, <span class="dt">y=</span>CO2)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">             </span><span class="kw">stat_smooth</span>(<span class="dt">method=</span><span class="st">&quot;lm&quot;</span>, <span class="dt">formula=</span>y <span class="op">~</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(x<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(x<span class="op">^</span><span class="dv">3</span>), <span class="dt">se=</span><span class="ot">FALSE</span>, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)</code></pre></div>
<p><img src="Week10a_files/figure-html/unnamed-chunk-7-1.png" width="576" /></p>
<p>Now, let’s look at the residuals. In helping discern any pattern in our residuals, we add a loess smooth to the plot.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">aes</span>(<span class="dt">x=</span>d2<span class="op">$</span>Year, <span class="dt">y=</span><span class="kw">residuals</span>(M2)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">           </span><span class="kw">stat_smooth</span>(<span class="dt">method=</span><span class="st">&quot;loess&quot;</span>, <span class="dt">se=</span><span class="ot">FALSE</span>)</code></pre></div>
<p><img src="Week10a_files/figure-html/unnamed-chunk-8-1.png" width="576" /></p>
<p>This is an improvement over the simple line model (which was a 1st order polynomial fit). So what we have learned so far is that the overall trend is not perfectly linear but instead follows a parabolic like trajectory with a small hump halfway across the time span. However, we can still make out a “W” shaped trend in the residuals which can hamper our analysis of the oscillatory patterns in the data. We could play with different order polynomials to smooth the trend even further, but at this point, we may opt for a non-parametric fit. When the goal is to <em>peel</em> off one pattern to explore any underlying pattern we should not limit ourselves to parametric fits (which impose a mathematical model on our data) and instead explore non-parametric smoothing techniques that do not impose any structure on the data. An example of such a smoothing technique is the loess fit which is shown in the following figure.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lo &lt;-<span class="st"> </span><span class="kw">loess</span>(CO2 <span class="op">~</span><span class="st"> </span>Year, d2, <span class="dt">span=</span><span class="dv">1</span><span class="op">/</span><span class="dv">4</span>)
<span class="kw">ggplot</span>(d2, <span class="kw">aes</span>(<span class="dt">x=</span>Year, <span class="dt">y=</span>CO2)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">             </span><span class="kw">stat_smooth</span>(<span class="dt">span=</span><span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">se=</span><span class="ot">FALSE</span>, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)</code></pre></div>
<p><img src="Week10a_files/figure-html/unnamed-chunk-9-1.png" width="576" /></p>
<p>At first glance, this may not look any different from our 3rd order polynomial. But the resulting residuals suggest that the loess smooth did a good job in removing any overall trend in our batch of CO2 values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">aes</span>(<span class="dt">x=</span>d2<span class="op">$</span>Year, <span class="dt">y=</span><span class="kw">residuals</span>(lo)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">           </span><span class="kw">stat_smooth</span>(<span class="dt">se=</span><span class="ot">FALSE</span>)</code></pre></div>
<p><img src="Week10a_files/figure-html/unnamed-chunk-10-1.png" width="576" /></p>
</div>
<div id="exploring-the-seasonal-component" class="section level1">
<h1>Exploring the seasonal component</h1>
<p>Let’s now explore the cyclical pattern in the residuals. Note the y-axis values: they are three orders of magnitude less than the overall range of CO2 values. This indicates that the oscillating nature along the overall trend is relatively small (the CO2 values have a range of [313.26, 401.83] whereas the residuals have a range of [-4.35, 3.94]).</p>
<p>Now, we may be tempted to fit a <em>smooth</em> (as Tukey would say) to the residuals but that may not prove to be fruitful. Instead let’s see if the oscillation follows a 12 month cycle. We’ll group all the residual values by month of the year. In other words, we will remove the year <em>tag</em> associated with each value and explore those values as a function of month alone. Each month’s batch of values is distilled into a boxplot.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Aggregate residuals by year</span>
d2<span class="op">$</span>Month &lt;-<span class="st"> </span><span class="kw">month</span>(d2<span class="op">$</span>Date, <span class="dt">label=</span><span class="ot">TRUE</span>) 
d2<span class="op">$</span>Resid &lt;-<span class="st"> </span><span class="kw">residuals</span>(lo)
<span class="kw">ggplot</span>(d2, <span class="kw">aes</span>(<span class="dt">x=</span>Month, <span class="dt">y=</span>Resid)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>()         </code></pre></div>
<p><img src="Week10a_files/figure-html/unnamed-chunk-11-1.png" width="576" /></p>
<p>It’s clear from the plot that the oscillation we observed in the CO2 plot follows a yearly cycle: a peak in the spring and a dip in the fall. This cycle is explained in part by the increased land mass in the northern hemisphere relative to the southern hemisphere. Because plants (and by extension photosynthesis) goes dormant during the winter months in the northern hemisphere, atmospheric CO2 is no longer being photosynthesized; this despite the southern hemisphere’s photosynthesis peak during the October-March period (a result of the southern hemisphere’s smaller land mass). Other factors such as increased CO2 emissions during the winter months may also contribute to the oscillatory nature of atmospheric CO2 concentrations.</p>
<p>Thus far, we have uncovered two patterns of interest: an overall trend and a cyclical component. Note that to effectively explore the cyclical pattern we had to <strong>de-trend</strong> (or <strong>smooth</strong>) the data. Next, we should <em>smooth</em> the seasonal component of the data to see if another pattern emerges. We may, for example, smooth the data by subtracting the monthly median from each residual leaving us with the next batch of residual values to explore:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d3 &lt;-<span class="st"> </span>d2 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(<span class="kw">month</span>(Date)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Resid.lev =</span> Resid <span class="op">-</span><span class="st"> </span><span class="kw">median</span>(Resid)) 

<span class="kw">ggplot</span>(d3, <span class="kw">aes</span>(<span class="dt">x=</span>Month, <span class="dt">y=</span>Resid.lev)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_boxplot</span>()     </code></pre></div>
<p><img src="Week10a_files/figure-html/unnamed-chunk-12-1.png" width="768" /></p>
<p>Note that now, all the boxplots are lined up along their median values. We are now exploring the data after having accounted for both overall trend and seasonality. What can be gleaned from this dataset? We may want to explore the skewed nature of the residuals in March, or the narrower range of CO2 values for the fall months, for example.</p>
<p>We may also be interested in seeing if any trend in CO2 concentrations exists within each month. Let’s explore this by fitting a first order polynomial to the monthly data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(d3, <span class="kw">aes</span>(<span class="dt">x=</span>Year, <span class="dt">y=</span>Resid.lev)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">col=</span><span class="st">&quot;grey&quot;</span>, <span class="dt">cex=</span>.<span class="dv">6</span>)  <span class="op">+</span><span class="st"> </span>
<span class="st">     </span><span class="kw">stat_smooth</span>(<span class="dt">se=</span><span class="ot">FALSE</span>, <span class="dt">method=</span><span class="st">&quot;lm&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">facet_grid</span>(. <span class="op">~</span><span class="st"> </span>Month)   </code></pre></div>
<p><img src="Week10a_files/figure-html/unnamed-chunk-13-1.png" width="768" /></p>
<p>Note the overall increase in CO2 for the winter and spring months followed by a similar (but not as persistent) decrease in CO2 loss in the summer and fall months. This suggests an increase in cyclical amplitude with the deviation from a central value being possibly greater for the winter/spring months.</p>
<p>Let’s fit a loess to see if the trends within each month are monotonic.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(d3, <span class="kw">aes</span>(<span class="dt">x=</span>Year, <span class="dt">y=</span>Resid.lev)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">col=</span><span class="st">&quot;grey&quot;</span>, <span class="dt">cex=</span>.<span class="dv">6</span>)  <span class="op">+</span><span class="st"> </span>
<span class="st">     </span><span class="kw">stat_smooth</span>(<span class="dt">method=</span><span class="st">&quot;loess&quot;</span>, <span class="dt">se=</span><span class="ot">FALSE</span>, 
                 <span class="dt">method.args=</span><span class="kw">list</span>(<span class="dt">family=</span><span class="st">&quot;symmetric&quot;</span>)) <span class="op">+</span><span class="st"> </span>
<span class="st">     </span><span class="kw">facet_grid</span>(. <span class="op">~</span><span class="st"> </span>Month)   </code></pre></div>
<p><img src="Week10a_files/figure-html/unnamed-chunk-14-1.png" width="768" /></p>
<p>The trends are clearly not monotonic suggesting that the processes driving the cyclical concentrations of CO2 are not systematic. However, despite the curved nature of the fits, the overall trends observed with the straight lines still remain.</p>
</div>
<div id="exploring-what-remains" class="section level1">
<h1>Exploring what remains</h1>
<p>Now that we’ve fitted the monthly medians to the seasonal component of the data, let’s plot the residuals across the years.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(d3, <span class="kw">aes</span>(<span class="dt">x=</span>Year, <span class="dt">y=</span>Resid.lev)) <span class="op">+</span><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">col=</span><span class="st">&quot;grey&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">     </span><span class="kw">stat_smooth</span>(<span class="dt">method=</span><span class="st">&quot;loess&quot;</span>, <span class="dt">se=</span><span class="ot">FALSE</span>, <span class="dt">span=</span><span class="fl">0.1</span> ,
                 <span class="dt">method.args=</span><span class="kw">list</span>(<span class="dt">family=</span><span class="st">&quot;symmetric&quot;</span>, <span class="dt">degree=</span><span class="dv">2</span>))    </code></pre></div>
<p><img src="Week10a_files/figure-html/unnamed-chunk-15-1.png" width="768" /></p>
<p>Recall that at this points, we have accounted for the overall increase (which has by far the greatest effect with a range of 75 ppm) and the seasonal component (which has a smaller effect with a range of about 6 ppm). The 3rd set of residuals account for about 2 ppm of the total variability in the dataset. Note that we can still make out the seasonal fluctuations if we look closely at the data. But we can also make out broader patterns of interest not consistent with random noise and not explained by seasonal variability. Some of the patterns could be explained by the southern oscillation index (SOI) which is a measure of the difference in atmospheric pressure across the pacific basin. When the index is positive the resulting winds drive upwelling currents that release additional CO2 into the atmosphere.</p>
<p>Let’s overlay the SOI data on top of our last plot.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyr)
<span class="kw">library</span>(lubridate)

soi &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;http://mgimond.github.io/ES218/Data/Southern_oscillation.csv&quot;</span>)

soi &lt;-<span class="st"> </span><span class="kw">gather</span>(soi,<span class="dt">key=</span>Month, <span class="dt">value=</span>Index, <span class="op">-</span><span class="dv">1</span>)
Date &lt;-<span class="st"> </span><span class="kw">ymd</span>(<span class="kw">paste</span>(soi<span class="op">$</span>YEAR, soi<span class="op">$</span>Month, <span class="dv">15</span>) )
soi<span class="op">$</span>Yr &lt;-<span class="st"> </span><span class="kw">decimal_date</span>(Date)

<span class="kw">ggplot</span>(d3, <span class="kw">aes</span>(<span class="dt">x=</span>Year, <span class="dt">y=</span>Resid.lev)) <span class="op">+</span><span class="st">  </span>
<span class="st">             </span><span class="kw">geom_line</span>(<span class="dt">col=</span><span class="st">&quot;blue&quot;</span>, <span class="dt">alpha=</span><span class="fl">0.2</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">             </span><span class="kw">stat_smooth</span>(<span class="dt">method=</span><span class="st">&quot;loess&quot;</span>, <span class="dt">se=</span><span class="ot">FALSE</span>, <span class="dt">span=</span><span class="fl">0.1</span>,
                         <span class="dt">method.args=</span><span class="kw">list</span>(<span class="dt">family=</span><span class="st">&quot;symmetric&quot;</span>, <span class="dt">degree=</span><span class="dv">2</span>)) <span class="op">+</span>
<span class="st">             </span><span class="kw">geom_line</span>(<span class="dt">dat=</span>soi, <span class="kw">aes</span>(Yr, Index<span class="op">/</span><span class="dv">2</span>, <span class="dt">colour=</span><span class="st">&quot;red&quot;</span>), <span class="dt">alpha=</span><span class="fl">0.3</span>) <span class="op">+</span>
<span class="st">             </span><span class="kw">stat_smooth</span>(<span class="dt">dat=</span>soi, <span class="kw">aes</span>(Yr, Index<span class="op">/</span><span class="dv">2</span>, <span class="dt">colour=</span><span class="st">&quot;red&quot;</span>),
                         <span class="dt">method=</span><span class="st">&quot;loess&quot;</span>, <span class="dt">se=</span><span class="ot">FALSE</span>, <span class="dt">span=</span><span class="fl">0.2</span>,
                         <span class="dt">method.args=</span><span class="kw">list</span>(<span class="dt">family=</span><span class="st">&quot;symmetric&quot;</span>, <span class="dt">degree=</span><span class="dv">2</span>)) <span class="op">+</span>
<span class="st">             </span><span class="kw">guides</span>(<span class="dt">color=</span><span class="ot">FALSE</span>)</code></pre></div>
<p><img src="Week10a_files/figure-html/unnamed-chunk-16-1.png" width="768" /></p>
<p>The blue lines represent the residuals (with the bold blue line showing the loess fit) and the red lines represent the SOI trend (with the bold line showing its loess fit). Note that we halved the SOI values to match the range along the y-scale; the intent is to facilitate the comparison of SOI trend to CO2 trend. There appears to be matching maxima (notably around 1975 and 1988) but we also note some opposing trends such as in the period after 2010. When the index drops below 0, “El Nino” events become more prominent and upwelling flows are suppressed. Though this may prevent CO2 trapped in the deeper Pacific oceans from reaching the surface, “El Nino” events can also have a measurable impact on land climate thus influencing the rate of vegetation growth and, by extension, CO2 uptake. El nino is also believed to increase the rate of forest and brush fires around the world which may also contribute to atmospheric CO2 concentrations.</p>
<p>It’s important to realize that this is one of many ways in which we could have proceeded with the analysis. For example, we could have started off the analysis by removing the seasonal component from the data, then analyzed the long term trend. This is the approach taken by William Cleveland on page 165 of the course’s text.</p>
</div>


<div class="footer">
<hr/>
<a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>  Manny Gimond (2018)
</br>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
